<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Second Example: Task-Based (Hi-Fi) fMRI &#8212; Monalisa 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="_static/custom-navigation.css?v=899df2ba" />
    <link rel="stylesheet" type="text/css" href="_static/custom-button.css?v=35775deb" />
    <link rel="stylesheet" type="text/css" href="_static/important.css?v=8e75c088" />
    <link rel="stylesheet" type="text/css" href="_static/tip.css?v=66ef22ed" />
    <script src="_static/documentation_options.js?v=01f34227"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/custom.js?v=35170ed4"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Third Example: Respiratory Binning for Motion-Resolved Cardiac MRI using Superior-Inferior (SI) Projections" href="2-4-3_binning_respiratory.html" />
    <link rel="prev" title="First Example: Sequential Binning" href="2-4-1_binning_eye_1.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
  <div role="main">
    
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="second-example-task-based-hi-fi-fmri">
<h1>Second Example: Task-Based (Hi-Fi) fMRI<a class="headerlink" href="#second-example-task-based-hi-fi-fmri" title="Link to this heading">¶</a></h1>
<p>This section discusses the binning process for task-based fMRI, which focuses on isolating the haemodynamic response to specific stimuli. By averaging multiple trials, this method effectively reduces the contributions of temporally uncorrelated brain activity, resulting in a clearer signal.</p>
<p>For instance, in a visual stimulation study, delayed activation in the brain’s visual processing regions can be captured without assumptions about the shape of the haemodynamic response. This is done by combining readouts from several trials and reconstruct images that reflect the average response across trials, minimizing the effect of noise from activations that are uncorrelated with the stimulation.</p>
<a class="reference internal image-reference" href="_images/hifi_fMRI_binning.png"><img alt="Task-based fMRI binning" class="align-center" src="_images/hifi_fMRI_binning.png" style="width: 90%;" />
</a>
<p>To implement this binning strategy, we generate a logical array, <cite>hifiMask</cite>, of size <cite>[nBins, nLines]</cite>, where <cite>hifiMask(i, j)</cite> is true if the j-th measurement corresponds to the i-th bin. The number of bins is determined by the total duration of the trial and the temporal resolution we aim to achieve for the haemodynamic response. Of course you need to have enogh lines in each bin if you want to successfully reconstruct images.</p>
<section id="steps-for-hi-fi-binning">
<h2>Steps for Hi-Fi Binning:<a class="headerlink" href="#steps-for-hi-fi-binning" title="Link to this heading">¶</a></h2>
<ol class="arabic">
<li><p><strong>Initialize and Set Parameters</strong>:</p>
<p>We extract parameters from the <cite>RawDataReader</cite> object, which include the number of measurements, segments, and the number of shots to exclude. This information is vital for creating the mask and ensuring accurate binning.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Extract parameters from acquisition</span>
<span class="n">acquisitionParams</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">acquisitionParams</span><span class="p">;</span>
<span class="c">% Total amount of lines</span>
<span class="n">nLines</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">acquisitionParams</span><span class="p">.</span><span class="n">nLine</span><span class="p">;</span>
<span class="c">% This only makes sense for phyllotaxis spiral</span>
<span class="n">nSeg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">acquisitionParams</span><span class="p">.</span><span class="n">nSeg</span><span class="p">;</span>
<span class="c">% Non steady state lines</span>
<span class="n">nSegNotSS</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">acquisitionParams</span><span class="p">.</span><span class="n">nShot_off</span><span class="o">*</span><span class="n">acquisitionParams</span><span class="p">.</span><span class="n">nSeg</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p><strong>Calculate Timestamps:</strong></p>
<p>Normalizing the timestamps allows us to accurately track the timing of each measurement in milliseconds. This is essential for defining the intervals for each bin.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Adjust timestamps and scale to milliseconds</span>
<span class="n">costTime</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">2.5</span><span class="p">;</span><span class="w">  </span><span class="c">% Siemens-specific constant</span>
<span class="n">timeStamp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">acquisitionParams</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span>
<span class="n">timeStamp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">timeStamp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">timeStamp</span><span class="p">);</span>
<span class="c">% Relative time w.r.t. beginning of acquisition in milliseconds</span>
<span class="n">timestampMs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">timeStamp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">costTime</span><span class="p">;</span>
<span class="c">% Non steady state time: example of filtering</span>
<span class="n">notSSTime</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">timestampMs</span><span class="p">(</span><span class="n">nSegNotSS</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p><strong>Determine Number of Bins:</strong></p>
<p>Based on the total duration of the trial and the specified temporal resolution, we calculate the number of bins required for the analysis. This is essential for structuring the <cite>hifiMask</cite> array correctly.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% We assume the stimulation and acquisition are synchronized</span>
<span class="n">nMasks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">floor</span><span class="p">(</span><span class="n">trialDurationSec</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">temporalResolutionSec</span><span class="p">);</span>
<span class="n">windowDuration</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">trialDurationSec</span><span class="o">/</span><span class="n">nMasks</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p><strong>Initialize the Mask Matrix:</strong></p>
<p>Create a logical mask matrix initialized to <cite>false</cite>, which will be populated with <cite>true</cite> values indicating the measurements belonging to each bin.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">hifiMask</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">(</span><span class="n">nMasks</span><span class="p">,</span><span class="w"> </span><span class="n">nLines</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p><strong>Populate the Bin Masks:</strong></p>
<p>For each bin, we define the time window and create a mask that indicates which measurements fall within that window. We also exclude specific measurements corresponding to SI projections to enhance the quality of the data. In this case we have to handle non steady state a bit differently: we cannot shift all the bins temporally as in the previous example, this is because binning is linked to the visual stimulation temporally.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">start</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">nMasks</span>
<span class="w">   </span><span class="n">maskOffset</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="nb">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">temporalResolutionSec</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="nb">j</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">nTrials</span>
<span class="w">      </span><span class="c">% Define the start and end of the current trial</span>
<span class="w">      </span><span class="n">trialStartTime</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="nb">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">trialDurationSec</span><span class="o">*</span><span class="mi">1000</span>

<span class="w">      </span><span class="n">windowStart</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">trialStartTime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">maskOffset</span><span class="p">;</span><span class="w"> </span><span class="c">% Convert to ms</span>
<span class="w">      </span><span class="n">windowEnd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">windowStart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">temporalResolutionSec</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>

<span class="w">      </span><span class="c">% Create the mask for the current trial</span>
<span class="w">      </span><span class="c">% Remove non steady state data</span>
<span class="w">      </span><span class="n">mask</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">timestampMs</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">notSSTime</span><span class="p">)</span><span class="w"> </span><span class="k">...</span>
<span class="w">      </span><span class="o">&amp;</span><span class="w">  </span><span class="p">(</span><span class="n">timestampMs</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">windowStart</span><span class="p">)</span><span class="w"> </span><span class="k">...</span>
<span class="w">      </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">timestampMs</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">windowEnd</span><span class="p">);</span>

<span class="w">      </span><span class="c">% Assign the mask to the hifiMask matrix</span>
<span class="w">      </span><span class="n">hifiMask</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">hifiMask</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">mask</span><span class="p">;</span>
<span class="k">end</span>
</pre></div>
</div>
</li>
</ol>
<p>The resulting <cite>hifiMask</cite> will allow for the reconstruction of images that reflect the average haemodynamic response across trials, facilitating more accurate analysis of brain activation during task-based fMRI studies.</p>
</section>
</section>


          </div>
          
        </div>
      </div>  <!-- This includes the original document content -->

    <!-- Back to Top Button -->
    <button onclick="scrollToTop()" id="back-to-top" title="Go to top">↑</button>
  </div>

      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Monalisa</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="1_quick_start.html">Quick Start</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="2_contents.html">Contents</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="2-1_introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="2-2_reconstruction_calls.html">Reconstruction Calls</a></li>
<li class="toctree-l2"><a class="reference internal" href="2-3_mitosius_prepare.html">The Mitosius</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="2-4_binning_masks.html">Binning: Flexible Readout Rearrangement</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="2-4-1_binning_eye_1.html">First Example: Sequential Binning</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Second Example: Task-Based (Hi-Fi) fMRI</a></li>
<li class="toctree-l3"><a class="reference internal" href="2-4-3_binning_respiratory.html">Third Example: Respiratory Binning for Motion-Resolved Cardiac MRI using Superior-Inferior (SI) Projections</a></li>
<li class="toctree-l3"><a class="reference internal" href="2-4-4_binning_cardiac.html">Fourth Example: Cardiac Binning for Motion-Resolved Cardiac MRI using Superior-Inferior (SI) Projections</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="2-5_coil_sensitivity_map.html">Coil Sensitivity Map Estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="2-6_prescan_acquisition.html">Acquisition Guidelines for Coil Sensitivity Estimation using Prescans</a></li>
<li class="toctree-l2"><a class="reference internal" href="2-7_discussion.html">Discussion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="3_examples.html">Examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="4_api.html">API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="5_docker.html">Docker for Monalisa</a></li>
<li class="toctree-l1"><a class="reference internal" href="6_ack_contribution.html">Acknowledgment and Authors</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="2_contents.html">Contents</a><ul>
  <li><a href="2-4_binning_masks.html">Binning: Flexible Readout Rearrangement</a><ul>
      <li>Previous: <a href="2-4-1_binning_eye_1.html" title="previous chapter">First Example: Sequential Binning</a></li>
      <li>Next: <a href="2-4-3_binning_respiratory.html" title="next chapter">Third Example: Respiratory Binning for Motion-Resolved Cardiac MRI using Superior-Inferior (SI) Projections</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Bastien Milani.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/2-4-2_binning_eye_2.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>