<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Volume Elements or Density Compensation &#8212; Monalisa 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="_static/custom-navigation.css?v=899df2ba" />
    <link rel="stylesheet" type="text/css" href="_static/custom-button.css?v=35775deb" />
    <link rel="stylesheet" type="text/css" href="_static/important.css?v=8e75c088" />
    <link rel="stylesheet" type="text/css" href="_static/tip.css?v=66ef22ed" />
    <script src="_static/documentation_options.js?v=01f34227"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "displayMath": [["$$", "$$"], ["\\[", "\\]"]]}, "TeX": {"Macros": {"coloneqq": "\\mathrel{\\mathpalette\\coloneqq@{}}", "parallel": "\\parallel"}}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/custom.js?v=35170ed4"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Examples" href="3_examples.html" />
    <link rel="prev" title="Reading Raw Data" href="2-7_raw_data_readers.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
  <div role="main">
    
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="volume-elements-or-density-compensation">
<h1>Volume Elements or Density Compensation<a class="headerlink" href="#volume-elements-or-density-compensation" title="Link to this heading">¶</a></h1>
<section id="what-are-volume-elements-basic-usage">
<h2>What are Volume Elements? Basic Usage<a class="headerlink" href="#what-are-volume-elements-basic-usage" title="Link to this heading">¶</a></h2>
<p>Volume elements act as weights for each sampling point in k-space, enabling accurate image reconstruction. For <strong>non-Cartesian distributions</strong>, the sampling density is not constant in k-space. This means some regions are sampled more densely than others. Without proper compensation, this uneven distribution can cause severe artifacts in the reconstructed image.</p>
<p>A useful intuition: the <strong>local point density</strong> is inversely proportional to the volume element:</p>
<div class="math notranslate nohighlight">
\[\text{Density at a point} \propto \frac{1}{\Delta k_p}.\]</div>
<p>This explains the term <strong>density compensation</strong> commonly used in MRI literature.</p>
<p>To compute the volume elements in <strong>Monalisa</strong>, use the following function:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">ve</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">bmVolumeElement</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span><span class="w"> </span><span class="n">type_of_trajectory</span><span class="p">,</span><span class="w"> </span><span class="n">optional_arguments</span><span class="p">)</span>
</pre></div>
</div>
<p>Here the parameters are:
- <cite>trajectory</cite>: The k-space sampling positions (see the Trajectory section in the docs).
- <cite>type_of_trajectory</cite>: A string that determines which model is used to compute the volume elements. Carefully choose from the table below:</p>
<table class="docutils align-default" id="id1">
<caption><span class="caption-text">Supported Trajectory Types</span><a class="headerlink" href="#id1" title="Link to this table">¶</a></caption>
<colgroup>
<col style="width: 33.3%" />
<col style="width: 33.3%" />
<col style="width: 33.3%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>type_of_trajectory</strong></p></th>
<th class="head"><p><strong>Required Parameters</strong></p></th>
<th class="head"><p><strong>Use Case</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">voronoi_center_out_radial2</span></code></p></td>
<td><p>None</p></td>
<td><p>2D radial trajectory with center-out spokes (typical for 2D UTE)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">voronoi_center_out_radial3</span></code></p></td>
<td><p>None</p></td>
<td><p>3D radial trajectory with center-out spokes (typical for 3D UTE)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">voronoi_full_radial2</span></code></p></td>
<td><p>None</p></td>
<td><p>2D full radial trajectory with diametric spokes (center sampled twice)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">voronoi_full_radial3</span></code></p></td>
<td><p>None</p></td>
<td><p>3D full radial trajectory with diametric spokes (center sampled twice)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">voronoi_full_radial2_nonUnique</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nAvg</span></code>: number of averages</p></td>
<td><p>2D full radial with duplicate samples, including multiple center acquisitions</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">voronoi_full_radial3_nonUnique</span></code></p></td>
<td><p>None</p></td>
<td><p>3D full radial with duplicate samples, including multiple center acquisitions</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">voronoi_box2</span></code></p></td>
<td><p>None</p></td>
<td><p>Generic 2D layout without duplicates; fallback when no other type fits</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">voronoi_box3</span></code></p></td>
<td><p>None</p></td>
<td><p>Generic 3D layout without duplicates; <strong>computationally expensive</strong>, avoid for large data</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">cartesian2</span></code></p></td>
<td><p>None</p></td>
<td><p>2D Cartesian grid (uniform sampling); assumes center point is at index N/2 + 1</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">cartesian3</span></code></p></td>
<td><p>None</p></td>
<td><p>3D Cartesian grid (uniform sampling); assumes center point is at index N/2 + 1</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">randomPartialCartesian2_x</span></code></p></td>
<td><p>None</p></td>
<td><p>2D Cartesian trajectory with randomly missing samples</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">randomPartialCartesian3_x</span></code></p></td>
<td><p>None</p></td>
<td><p>3D Cartesian trajectory with randomly missing samples</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">center_out_radial3</span></code></p></td>
<td><p>None</p></td>
<td><p>Fast approximate estimation for 3D center-out radial (non-Voronoi)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">full_radial3</span></code></p></td>
<td><p>None</p></td>
<td><p>Fast approximate estimation for 3D full radial (non-Voronoi)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">imDeformField2</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">deformationField</span></code>: deformation vector field</p></td>
<td><p>2D volume elements corrected for deformation fields (motion/distortion)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">imDeformField3</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">deformationField</span></code>: deformation vector field</p></td>
<td><p>3D volume elements corrected for deformation fields (motion/distortion)</p></td>
</tr>
</tbody>
</table>
<p>You don’t see your usecase, or you don’t know which to pick? Consider opening an issue on Monalisa’s GitHub page.</p>
<p>Volume elements are typically computed using <strong>Voronoi parcellation</strong>, which naturally estimates how much space each point “owns” in k-space. Each Voronoi cell contains all points closer to a given sample than to any other.</p>
<p><strong>Important notes:</strong></p>
<ul class="simple">
<li><p>Volume elements <strong>depend on binning</strong>. If you divide your acquisition into bins (e.g., for motion correction), recompute the volume elements <strong>after</strong> binning.</p></li>
<li><p>It is <strong>strongly recommended</strong> to set a <cite>ve_max</cite> threshold to avoid numerical instability.</p></li>
<li><p>Output <cite>ve</cite> is a <cite>[1, nPt]</cite> double-precision vector.</p></li>
<li><p>The function does <strong>not</strong> normalize or rescale values.</p></li>
</ul>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Set maximum volume element to avoid instability</span>
<span class="n">ve_max</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dKu_x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dKu_y</span><span class="p">;</span><span class="w">  </span><span class="c">% For 2D</span>
<span class="n">ve_max</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dKu_x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dKu_y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dKu_z</span><span class="p">;</span><span class="w">  </span><span class="c">% For 3D</span>
</pre></div>
</div>
</section>
<section id="ok-but-why-are-there-volume-elements">
<h2>Ok, but why are there Volume Elements?<a class="headerlink" href="#ok-but-why-are-there-volume-elements" title="Link to this heading">¶</a></h2>
<p>Volume elements originate from the need to approximate integrals using discrete data. For example, consider the goal of computing:</p>
<div class="math notranslate nohighlight">
\[\int_{\mathbb{R}^3} f(\mathbf{k})\,d^3\mathbf{k}.\]</div>
<p>With sampled k-space points <span class="math notranslate nohighlight">\(\{\mathbf{k}_p\}_{p=1}^N\)</span>, we approximate:</p>
<div class="math notranslate nohighlight">
\[\int_{\mathbb{R}^3} f(\mathbf{k})\,d^3\mathbf{k} \approx \sum_{p=1}^{N} \Delta k_p\, f(\mathbf{k}_p),\]</div>
<p>where <span class="math notranslate nohighlight">\(\Delta k_p\)</span> is the <strong>volume element</strong> for point <span class="math notranslate nohighlight">\(\mathbf{k}_p\)</span>.</p>
<p>In <strong>Cartesian sampling</strong>, all <span class="math notranslate nohighlight">\(\Delta k_p\)</span> are constant, so we write:</p>
<div class="math notranslate nohighlight">
\[\int_{\mathbb{R}^3} f(\mathbf{k})\,d^3\mathbf{k} \approx \Delta k \sum_{p=1}^{N} f(\mathbf{k}_p).\]</div>
<p>And therefore can be ignored since anyways raw data are usually normalized. However, in <strong>non-Cartesian sampling</strong>, the density of points varies across space, hence we need to estimate the <span class="math notranslate nohighlight">\(\Delta k_p\)</span> for each point to correctly approximate the integral. For example <strong>Radial</strong> sampling oversamples the center. Historically, this concept is referred to as “density compensation” in MRI, originating from the transition from uniform trajectories, where the density is constant and can be neglected, to non-uniform trajectories. Although non-uniform density was once viewed as a problem to be “compensated”, it is in fact the general case, with uniform sampling being a special scenario.</p>
</section>
</section>


          </div>
          
        </div>
      </div>  <!-- This includes the original document content -->

    <!-- Back to Top Button -->
    <button onclick="scrollToTop()" id="back-to-top" title="Go to top">↑</button>
  </div>

      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Monalisa</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="1_quick_start.html">Quick Start</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="2_contents.html">Contents</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="2-1_introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="2-2_reconstruction_calls.html">Reconstruction Calls</a></li>
<li class="toctree-l2"><a class="reference internal" href="2-3_mitosius_prepare.html">The Mitosius</a></li>
<li class="toctree-l2"><a class="reference internal" href="2-4_binning_masks.html">Binning: Flexible Readout Rearrangement</a></li>
<li class="toctree-l2"><a class="reference internal" href="2-5_coil_sensitivity_map.html">Coil Sensitivity Map Estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="2-6_prescan_acquisition.html">Acquisition Guidelines for Coil Sensitivity Estimation using Prescans</a></li>
<li class="toctree-l2"><a class="reference internal" href="2-7_raw_data_readers.html">Reading Raw Data</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Volume Elements or Density Compensation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-are-volume-elements-basic-usage">What are Volume Elements? Basic Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ok-but-why-are-there-volume-elements">Ok, but why are there Volume Elements?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="3_examples.html">Examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="4_api.html">API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="5_docker.html">Docker for Monalisa</a></li>
<li class="toctree-l1"><a class="reference internal" href="6_ack_contribution.html">Acknowledgment and Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="7_discussions.html">Discussion</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="2_contents.html">Contents</a><ul>
      <li>Previous: <a href="2-7_raw_data_readers.html" title="previous chapter">Reading Raw Data</a></li>
      <li>Next: <a href="3_examples.html" title="next chapter">Examples</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Bastien Milani.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/2-8_volume_elements.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>